# 设计文档

## 概述

本设计文档描述了一个专业的 macOS 应用发布网站的技术架构和实现方案。网站采用现代化的静态网站架构，结合无服务器后端服务，实现高性能、低成本、易维护的解决方案。

设计灵感来源于 Sublime Text 官网的简洁专业风格，强调内容优先、视觉清晰、交互流畅。

## 架构

### 整体架构

网站采用 **Jamstack 架构**（JavaScript, APIs, Markup），将前端和后端解耦：

```
┌─────────────────────────────────────────────────────────────┐
│                         用户浏览器                            │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                    CloudFront (CDN)                          │
└────────────────────┬────────────────────────────────────────┘
                     │
        ┌────────────┴────────────┐
        ▼                         ▼
┌──────────────┐          ┌──────────────────┐
│   S3 Bucket  │          │  API Gateway     │
│  (静态资源)   │          │  (REST API)      │
└──────────────┘          └────────┬─────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    ▼              ▼              ▼
            ┌──────────┐   ┌──────────┐   ┌──────────┐
            │ Lambda   │   │ Lambda   │   │ Lambda   │
            │ (留言)    │   │ (下载)    │   │ (统计)    │
            └────┬─────┘   └────┬─────┘   └────┬─────┘
                 │              │              │
                 └──────────────┼──────────────┘
                                ▼
                        ┌──────────────┐
                        │  DynamoDB    │
                        │  (数据存储)   │
                        └──────────────┘
```

### 技术栈选择

**前端**：
- HTML5 + CSS3（原生实现，无框架依赖）
- Vanilla JavaScript（轻量级，快速加载）
- 响应式设计（CSS Grid + Flexbox）

**后端**：
- AWS Lambda（Node.js 运行时）
- API Gateway（REST API）
- DynamoDB（NoSQL 数据库）

**部署和 CDN**：
- AWS S3（静态网站托管）
- CloudFront（全球 CDN 加速）

**理由**：
1. 无服务器架构降低运维成本
2. 静态网站提供最佳性能
3. 按需付费，流量小时成本极低
4. 自动扩展，无需担心并发问题

## 组件和接口

### 前端组件

#### 1. 页面结构组件

**导航栏（Navigation Bar）**
- 固定在页面顶部
- 包含 Logo、导航链接（首页、特性、下载、留言板）
- 响应式汉堡菜单（移动端）

**主页横幅（Hero Section）**
- 应用名称和标语
- 主要 CTA 按钮（下载）
- 应用截图或演示视频
- 下载统计显示

**特性展示区（Features Section）**
- 网格布局展示 3-6 个主要特性
- 每个特性包含图标、标题、描述
- 滚动动画效果

**下载区域（Download Section）**
- 下载按钮
- 版本信息和发布日期
- 系统要求说明
- 总下载次数显示

**留言板区域（Guestbook Section）**
- 留言列表（分页显示）
- 留言表单（昵称、内容）
- 提交按钮和速率限制提示

**页脚（Footer）**
- 版权信息
- 联系方式
- 社交媒体链接

#### 2. 交互组件

**下载按钮（Download Button）**
```javascript
接口：
- onClick(): void - 触发下载并记录统计
- showProgress(): void - 显示下载进度
- updateDownloadCount(): void - 更新显示的下载次数
```

**留言表单（Guestbook Form）**
```javascript
接口：
- validateInput(): boolean - 验证输入内容
- checkRateLimit(): boolean - 检查速率限制
- submitMessage(): Promise<void> - 提交留言
- displayError(message: string): void - 显示错误信息
```

**留言列表（Message List）**
```javascript
接口：
- loadMessages(page: number): Promise<void> - 加载留言
- renderMessage(message: Message): HTMLElement - 渲染单条留言
- paginate(): void - 分页控制
```

### 后端 API 接口

#### API 端点设计

**1. 下载统计 API**

```
POST /api/downloads
功能：记录下载事件并返回总下载次数
请求体：
{
  "timestamp": "2024-01-01T12:00:00Z",
  "userAgent": "Mozilla/5.0...",
  "ipAddress": "xxx.xxx.xxx.xxx" (可选，用于去重)
}

响应：
{
  "success": true,
  "totalDownloads": 12345
}
```

**2. 获取下载统计 API**

```
GET /api/downloads/stats
功能：获取当前总下载次数
响应：
{
  "totalDownloads": 12345,
  "lastUpdated": "2024-01-01T12:00:00Z"
}
```

**3. 提交留言 API**

```
POST /api/messages
功能：提交新留言（包含速率限制）
请求体：
{
  "nickname": "用户昵称",
  "content": "留言内容",
  "timestamp": "2024-01-01T12:00:00Z"
}

响应（成功）：
{
  "success": true,
  "messageId": "msg-123456",
  "message": "留言已发布"
}

响应（速率限制）：
{
  "success": false,
  "error": "RATE_LIMIT_EXCEEDED",
  "message": "请等待 45 秒后再次留言",
  "retryAfter": 45
}
```

**4. 获取留言列表 API**

```
GET /api/messages?page=1&limit=20
功能：获取留言列表（分页）
响应：
{
  "messages": [
    {
      "id": "msg-123456",
      "nickname": "用户昵称",
      "content": "留言内容",
      "timestamp": "2024-01-01T12:00:00Z"
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalMessages": 100
  }
}
```

### Lambda 函数设计

**1. DownloadHandler Lambda**
- 功能：处理下载统计
- 触发器：API Gateway POST /api/downloads
- 逻辑：
  1. 验证请求
  2. 增加 DynamoDB 计数器
  3. 返回总下载次数

**2. MessageHandler Lambda**
- 功能：处理留言提交和查询
- 触发器：API Gateway POST/GET /api/messages
- 逻辑：
  1. POST：检查速率限制 → 验证输入 → 存储留言
  2. GET：查询留言 → 分页 → 返回结果

**3. RateLimiter 中间件**
- 功能：实现速率限制
- 存储：DynamoDB（记录 IP + 时间戳）
- 逻辑：
  1. 获取客户端标识（IP 地址）
  2. 查询最近一分钟的请求记录
  3. 如果超过限制，返回错误和等待时间
  4. 否则允许请求并记录时间戳

## 数据模型

### DynamoDB 表设计

**1. Downloads 表**
```
表名：macos-app-downloads
主键：id (String) - 固定值 "download-counter"
属性：
- count (Number) - 总下载次数
- lastUpdated (String) - 最后更新时间（ISO 8601）
```

**2. Messages 表**
```
表名：macos-app-messages
主键：id (String) - 留言 ID（UUID）
排序键：timestamp (String) - 发布时间（ISO 8601，用于排序）
属性：
- nickname (String) - 用户昵称
- content (String) - 留言内容
- ipHash (String) - IP 地址哈希（用于速率限制，不存储原始 IP）

全局二级索引：
- timestamp-index：按时间倒序查询留言
```

**3. RateLimits 表**
```
表名：macos-app-rate-limits
主键：identifier (String) - 客户端标识（IP 哈希）
属性：
- lastRequestTime (Number) - 最后请求时间（Unix 时间戳）
- requestCount (Number) - 请求次数（可选，用于更复杂的限制）
TTL 属性：expiresAt (Number) - 自动过期时间（60 秒后）
```

### 数据流

**下载流程**：
```
用户点击下载 → 前端发送 POST /api/downloads
→ Lambda 增加计数器 → 返回新的总数
→ 前端更新显示 → 浏览器开始下载文件
```

**留言流程**：
```
用户提交留言 → 前端发送 POST /api/messages
→ Lambda 检查速率限制 → 验证输入
→ 存储到 DynamoDB → 返回成功
→ 前端刷新留言列表
```

## 正确性属性

*属性是一个特征或行为，应该在系统的所有有效执行中保持为真——本质上是关于系统应该做什么的形式化陈述。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。*


### 属性 1：导航栏固定定位
*对于任何*滚动位置，导航栏应该始终保持在视口顶部可见
**验证需求：1.3**

### 属性 2：响应式布局适配
*对于任何*视口宽度变化，页面布局应该自动调整以适应新的屏幕尺寸
**验证需求：1.5, 4.4**

### 属性 3：下载计数递增
*对于任何*成功的下载请求，总下载次数应该增加 1
**验证需求：2.6**

### 属性 4：特性项完整性
*对于任何*特性展示项，都应该包含标题、描述和图标/图片这三个元素
**验证需求：3.2**

### 属性 5：触摸目标尺寸
*对于任何*交互元素（按钮、链接），其可点击区域应该至少为 44x44 像素（符合触摸标准）
**验证需求：4.5**

### 属性 6：导航平滑滚动
*对于任何*导航链接点击，页面应该平滑滚动到对应的目标区域
**验证需求：5.2**

### 属性 7：导航状态同步
*对于任何*页面滚动位置，当前可见区域对应的导航项应该被高亮显示
**验证需求：5.3**

### 属性 8：图片懒加载
*对于任何*非首屏图片，都应该使用懒加载属性（loading="lazy"）
**验证需求：6.3**

### 属性 9：配色一致性
*对于任何*使用主题颜色的元素，颜色值应该来自预定义的 CSS 变量（确保一致性）
**验证需求：7.2**

### 属性 10：留言显示完整性
*对于任何*显示的留言，都应该包含昵称、内容和时间戳这三个信息
**验证需求：8.2**

### 属性 11：留言时间倒序
*对于任何*留言列表，留言应该按时间戳倒序排列（最新的在最前）
**验证需求：8.3**

### 属性 12：表单输入验证
*对于任何*无效的留言输入（空内容、过长内容、无效字符），表单验证应该拒绝提交
**验证需求：8.5**

### 属性 13：速率限制执行
*对于任何*访问者，在一分钟时间窗口内只能成功提交一条留言，第二次尝试应该被拒绝
**验证需求：9.1**

### 属性 14：访问者标识追踪
*对于任何*留言请求，系统应该能够通过 IP 地址或浏览器指纹唯一标识访问者
**验证需求：9.3**

### 属性 15：速率限制过期
*对于任何*被速率限制的访问者，在 60 秒后应该能够再次成功提交留言
**验证需求：9.4**

### 属性 16：图片替代文本
*对于任何*图片元素（<img>），都应该包含非空的 alt 属性
**验证需求：10.1**

### 属性 17：颜色对比度
*对于任何*文本元素，其颜色与背景颜色的对比度应该至少为 4.5:1（WCAG AA 标准）
**验证需求：10.2**

### 属性 18：键盘可访问性
*对于任何*交互元素（按钮、链接、表单控件），都应该可以通过键盘 Tab 键聚焦和操作
**验证需求：10.3**

### 属性 19：语义化 HTML
*对于任何*页面区域，都应该使用语义化的 HTML5 标签（header, nav, main, section, footer 等）
**验证需求：10.4**

### 属性 20：内容朗读顺序
*对于任何*页面内容，DOM 元素的顺序应该与视觉呈现的逻辑顺序一致（确保屏幕阅读器正确朗读）
**验证需求：10.5**

## 错误处理

### 前端错误处理

**1. 网络请求失败**
- 场景：API 请求超时或失败
- 处理：显示友好的错误提示，提供重试按钮
- 用户体验：不阻塞页面其他功能

**2. 下载失败**
- 场景：下载链接不可用或下载中断
- 处理：显示错误信息，提供重新下载选项
- 日志：记录错误到浏览器控制台

**3. 表单验证错误**
- 场景：用户输入无效数据
- 处理：实时显示验证错误，高亮错误字段
- 提示：提供清晰的错误说明和修正建议

**4. 速率限制错误**
- 场景：用户触发速率限制
- 处理：显示倒计时，告知用户等待时间
- 用户体验：禁用提交按钮直到限制解除

### 后端错误处理

**1. Lambda 函数错误**
- 场景：函数执行异常
- 处理：捕获异常，返回标准错误响应
- 日志：记录到 CloudWatch Logs
- 响应格式：
```json
{
  "success": false,
  "error": "ERROR_CODE",
  "message": "用户友好的错误描述"
}
```

**2. DynamoDB 错误**
- 场景：数据库读写失败
- 处理：重试机制（最多 3 次）
- 降级：如果持续失败，返回缓存数据或默认值

**3. 速率限制检查失败**
- 场景：无法读取速率限制记录
- 处理：采用保守策略，允许请求通过（避免误拦截）
- 日志：记录异常情况

**4. 输入验证失败**
- 场景：恶意或格式错误的输入
- 处理：拒绝请求，返回 400 错误
- 安全：防止 XSS 和 SQL 注入（虽然使用 NoSQL）

### 错误响应标准

所有 API 错误响应遵循统一格式：
```json
{
  "success": false,
  "error": "ERROR_CODE",
  "message": "用户可读的错误描述",
  "details": {
    // 可选的详细信息
  }
}
```

常见错误码：
- `RATE_LIMIT_EXCEEDED`: 速率限制
- `INVALID_INPUT`: 输入验证失败
- `NOT_FOUND`: 资源不存在
- `INTERNAL_ERROR`: 服务器内部错误
- `SERVICE_UNAVAILABLE`: 服务暂时不可用

## 测试策略

### 双重测试方法

本项目采用**单元测试**和**基于属性的测试**相结合的策略：

- **单元测试**：验证特定示例、边缘情况和错误条件
- **属性测试**：验证跨所有输入的通用属性
- 两者互补，共同确保全面覆盖

### 单元测试重点

单元测试应该专注于：
- 特定示例（如特定视口宽度下的布局）
- 集成点（前端与 API 的交互）
- 边缘情况（空输入、超长输入、特殊字符）
- 错误条件（网络失败、API 错误）

避免编写过多单元测试 - 属性测试已经覆盖了大量输入场景。

### 基于属性的测试

**测试库选择**：
- 前端：使用 **fast-check**（JavaScript 属性测试库）
- 后端：使用 **fast-check**（Node.js Lambda 函数）

**配置要求**：
- 每个属性测试至少运行 **100 次迭代**（由于随机化）
- 每个测试必须引用设计文档中的属性
- 标签格式：`Feature: macos-app-website, Property {number}: {property_text}`

**属性测试实现**：
- 每个正确性属性必须由**单个**属性测试实现
- 测试应该生成随机输入并验证属性始终成立
- 使用 fast-check 的生成器创建测试数据

### 测试覆盖范围

**前端测试**：
1. DOM 结构和语义化 HTML（属性 19）
2. 响应式布局（属性 2）
3. 导航行为（属性 6, 7）
4. 表单验证（属性 12）
5. 可访问性（属性 16, 17, 18, 20）
6. 懒加载（属性 8）

**后端测试**：
1. 下载计数逻辑（属性 3）
2. 留言存储和检索（属性 10, 11）
3. 速率限制（属性 13, 14, 15）
4. 输入验证和清理
5. 错误处理

**集成测试**：
1. 端到端下载流程
2. 留言提交和显示流程
3. 速率限制的客户端和服务器端协同

### 测试示例

**属性测试示例（使用 fast-check）**：
```javascript
// Feature: macos-app-website, Property 3: 下载计数递增
test('下载计数应该对每次下载递增 1', () => {
  fc.assert(
    fc.property(fc.nat(), async (initialCount) => {
      // 设置初始计数
      await setDownloadCount(initialCount);
      
      // 执行下载
      const result = await recordDownload();
      
      // 验证计数增加了 1
      expect(result.totalDownloads).toBe(initialCount + 1);
    }),
    { numRuns: 100 }
  );
});
```

### 持续集成

- 所有测试在每次提交时自动运行
- 属性测试失败时，保存失败的输入用于调试
- 代码覆盖率目标：至少 80%

## AWS 部署架构和成本估算

### 部署组件

**1. S3 + CloudFront**
- S3 存储静态文件（HTML, CSS, JS, 图片）
- CloudFront 提供全球 CDN 加速
- 成本：主要是存储和流量

**2. API Gateway + Lambda**
- API Gateway 提供 REST API 端点
- Lambda 函数处理业务逻辑
- 成本：按请求次数和执行时间计费

**3. DynamoDB**
- 存储留言和统计数据
- 按需计费模式（适合低流量）
- 成本：按读写请求和存储计费

### 成本估算（月度）

假设流量场景：
- 每月访问量：10,000 次
- 每月下载量：1,000 次
- 每月留言量：500 条
- 网站大小：50 MB（包含图片）

**详细成本分解**：

1. **S3 存储**：
   - 存储：50 MB × $0.023/GB = $0.001
   - GET 请求：10,000 × $0.0004/1000 = $0.004
   - 数据传输：忽略（通过 CloudFront）
   - 小计：**$0.01/月**

2. **CloudFront**：
   - 数据传输：假设 10,000 访问 × 2 MB = 20 GB
   - 20 GB × $0.085/GB = $1.70
   - HTTP 请求：10,000 × $0.0075/10000 = $0.0075
   - 小计：**$1.71/月**

3. **API Gateway**：
   - REST API 请求：1,500（下载 + 留言）
   - 1,500 × $3.50/百万 = $0.005
   - 小计：**$0.01/月**

4. **Lambda**：
   - 请求次数：1,500
   - 1,500 × $0.20/百万 = $0.0003
   - 计算时间：1,500 × 100ms × $0.0000166667/GB-秒 = $0.0025
   - 小计：**$0.01/月**

5. **DynamoDB**：
   - 按需模式
   - 写入：500 条留言 + 1,000 次下载 = 1,500 写入
   - 1,500 × $1.25/百万 = $0.002
   - 读取：10,000 次（留言列表）
   - 10,000 × $0.25/百万 = $0.0025
   - 存储：1 GB × $0.25 = $0.25
   - 小计：**$0.26/月**

**总计：约 $2-3/月**

### 成本优化建议

1. **使用 AWS 免费套餐**：
   - Lambda：每月 100 万次免费请求
   - API Gateway：每月 100 万次免费请求（首 12 个月）
   - DynamoDB：25 GB 免费存储
   - CloudFront：每月 1 TB 免费流量（首 12 个月）
   - **实际成本可能接近 $0**（在免费套餐内）

2. **缓存策略**：
   - CloudFront 缓存静态资源（减少 S3 请求）
   - API Gateway 缓存（减少 Lambda 调用）
   - 浏览器缓存（减少重复请求）

3. **资源优化**：
   - 压缩图片（减少传输成本）
   - 最小化 JS/CSS（减少文件大小）
   - 使用 WebP 格式（更好的压缩率）

### 扩展性

当流量增长时：
- Lambda 自动扩展，无需配置
- DynamoDB 按需模式自动调整容量
- CloudFront 全球分布，自动处理高流量
- 成本随使用量线性增长，无需预付费

**流量增长 10 倍（10 万访问/月）**：
- 估算成本：约 $20-30/月
- 仍然非常经济实惠

## 实现注意事项

### 前端开发

1. **使用原生 JavaScript**：
   - 避免引入大型框架（React, Vue）
   - 保持页面轻量快速
   - 使用现代 ES6+ 特性

2. **CSS 组织**：
   - 使用 CSS 变量定义主题
   - 移动优先的响应式设计
   - 使用 CSS Grid 和 Flexbox

3. **性能优化**：
   - 关键 CSS 内联
   - 异步加载非关键 JavaScript
   - 图片懒加载和响应式图片

### 后端开发

1. **Lambda 函数优化**：
   - 保持函数小而专注
   - 使用环境变量配置
   - 实现适当的超时和重试

2. **DynamoDB 设计**：
   - 选择合适的主键和索引
   - 使用 TTL 自动清理过期数据
   - 批量操作提高效率

3. **安全性**：
   - 输入验证和清理
   - CORS 配置
   - API 密钥或 JWT 认证（如需要）
   - HTTPS 强制使用

### 部署流程

1. **基础设施即代码**：
   - 使用 AWS CloudFormation 或 Terraform
   - 版本控制所有配置
   - 自动化部署流程

2. **CI/CD**：
   - GitHub Actions 或 AWS CodePipeline
   - 自动测试和部署
   - 蓝绿部署或金丝雀发布

3. **监控和日志**：
   - CloudWatch 监控 Lambda 和 API Gateway
   - 设置告警（错误率、延迟）
   - 日志聚合和分析

## 总结

本设计提供了一个完整的、可扩展的、成本效益高的 macOS 应用发布网站解决方案。通过使用现代 Web 技术和 AWS 无服务器架构，我们可以构建一个专业、快速、可靠的网站，同时保持极低的运营成本。

关键优势：
- ✅ 简洁专业的设计（类似 Sublime Text）
- ✅ 完整的功能（展示、下载、留言板）
- ✅ 高性能（静态网站 + CDN）
- ✅ 低成本（月度成本 $2-3，或免费套餐内）
- ✅ 可扩展（自动扩展，无需配置）
- ✅ 易维护（无服务器，无需管理服务器）
